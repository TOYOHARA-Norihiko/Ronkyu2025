---
title: "Fig 5"
author: "N Toyohara"
output: html_document
---
[← Index（目次）に戻る](https://toyohara-norihiko.github.io/Ronkyu2025/)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data, echo=FALSE}
library(openxlsx)
library(WaveletComp)

## ---- データ読み込み ----
filnam <- "kansai_cli_ci_c.xlsx"
data  <- read.xlsx(filnam, sheet = 1)

# 2018-01 から nrow(data) ヶ月分の Date ベクトル
date1 <- seq.Date(from = as.Date("2018-01-01"),
                  by   = "month",
                  length.out = nrow(data))

x <- 0.473*data$osaka_cli +
              0.235*data$hyogo_cli +
              0.127*data$kyoto_cli +
              0.074*data$shiga_cli +
              0.045*data$nara_cli  +
              0.046*data$waka_cli
y <- 0.473*data$osaka_ci_c +
              0.235*data$hyogo_ci_c +
              0.127*data$kyoto_ci_c +
              0.074*data$shiga_ci_c +
              0.045*data$nara_ci_c  +
              0.046*data$waka_ci_c

df1 <- data.frame(date = date1, data, kansai_cli = x, kansai_ci_c = y)


## ---- CLI と CI_C をラグさせたデータフレームを作る関数 ----
# L > 0  : CLI が L か月先行（CLI[t-L] vs CI_C[t]）
# L = 0  : 同時
# L < 0  : CLI が |L| か月遅行（CLI[t+|L|] vs CI_C[t]）
make_lag_df <- function(date, cli, ci_c, L) {
  N <- length(cli)

  if (L > 0) {
    # CLI 先行 L：CLI[t-L] と CI_C[t] を揃える
    idx <- (L + 1):N              # t = L+1, ..., N
    cli_l <- cli[idx-L]         # t-L = 1, ..., N-L
    ci_l  <- ci_c[idx]            # t   = L+1, ..., N
    d_l   <- date[idx]            # 時点は CI_C 側に合わせる
  } else if (L < 0) {
    k <- -L                       # CLI 遅行 k
    idx <- 1:(N - k)              # t = 1, ..., N-k
    cli_l <- cli[idx + k]         # t+k = 1+k, ..., N
    ci_l  <- ci_c[idx]            # t   = 1, ..., N-k
    d_l   <- date[idx]            # 時点は CI_C 側に合わせる
  } else {                        # L == 0
    cli_l <- cli
    ci_l  <- ci_c
    d_l   <- date
  }

  data.frame(
    date = d_l,
    cli  = cli_l,
    ci_c = ci_l
  )
}

## ---- 対象府県 ----
pref_codes <- c("kansai")

## ---- ラグの範囲（CLI が -3〜+6 か月の先行/遅行） ----
lag_seq <- -3:6
#lag_seq <- -10:0

## ---- 各府県・各ラグでコヒーレンスを描画 ----
for (pref in pref_codes) {

  cli_col <- paste0(pref, "_cli")
  ci_col  <- paste0(pref, "_ci_c")

  cli0   <- df1[[cli_col]]
  ci0    <- df1[[ci_col]]
  date0  <- df1$date

  for (L in lag_seq) {

    df_lag <- make_lag_df(date0, cli0, ci0, L)

sink("nul")
    wc <- analyze.coherency(
      my.data     = df_lag,
      my.pair     = c("cli", "ci_c"),
      loess.span  = 0,
      dt          = 1,
      dj          = 1/12,
      lowerPeriod = 2,
      upperPeriod = 64,
      window.size.t = 3,   # Bartlett window 用に 3 以上にしておく
      window.size.s = 1,
      make.pval   = TRUE,
      n.sim       = 200
    )
sink()

    # タイトル（先行/遅行をわかりやすく）
    lag_label <- if (L > 0) {
      paste0("CLI leads CI_C by ", L, " months")
    } else if (L < 0) {
      paste0("CLI lags CI_C by ", -L, " months")
    } else {
      "CLI and CI_C at same time"
    }

    main_txt <- paste0(
      toupper(pref), ": ", lag_label
    )

    years <- unique(format(df_lag$date, "%Y"))
tick_dates <- as.Date(paste0(years, "-01-01"))
    
    # コヒーレンス図（→ の変化を見る）
    wc.image(
      wc,
      which.image   = "wc",      # コヒーレンス
      color.key     = "i",       # 0〜1 の値を等間隔
      plot.arrow    = TRUE,      # 位相矢印 →
      main          = main_txt,
      legend.params = list(
        lab = "Wavelet coherence"
      ),
      periodlab     = "Period (months)",
  show.date   = TRUE,
  timelab     = "Year",
  spec.time.axis = list(
    at      = tick_dates,
    labels = years,
    las    = 1   # 横書き
  )
      
    )

  }
}
```

